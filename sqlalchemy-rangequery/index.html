<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>[译文] RangeQuery and WindowedRangeQuery - tsing.fun</title><meta name=Description content="A blog about programming、technical support、life, and other things."><meta property="og:title" content="[译文] RangeQuery and WindowedRangeQuery"><meta property="og:description" content="近期在使用 SQLAlchemy 读取大批量数据的时候，遇到了一个问题，因为数据量过大而查询进程被 Kill 的问题，就想到了使用生成器或者单个请求拆分多次查询的方法。在 github"><meta property="og:type" content="article"><meta property="og:url" content="http://tsing.fun/sqlalchemy-rangequery/"><meta property="og:image" content="http://tsing.fun/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-02T20:43:53+08:00"><meta property="article:modified_time" content="2022-04-02T20:43:53+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://tsing.fun/logo.png"><meta name=twitter:title content="[译文] RangeQuery and WindowedRangeQuery"><meta name=twitter:description content="近期在使用 SQLAlchemy 读取大批量数据的时候，遇到了一个问题，因为数据量过大而查询进程被 Kill 的问题，就想到了使用生成器或者单个请求拆分多次查询的方法。在 github"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://tsing.fun/sqlalchemy-rangequery/><link rel=prev href=http://tsing.fun/first_post/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[译文] RangeQuery and WindowedRangeQuery","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/tsing.fun\/sqlalchemy-rangequery\/"},"genre":"posts","wordcount":1463,"url":"http:\/\/tsing.fun\/sqlalchemy-rangequery\/","datePublished":"2022-04-02T20:43:53+08:00","dateModified":"2022-04-02T20:43:53+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"zhanghb"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=tsing.fun></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=tsing.fun></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">[译文] RangeQuery and WindowedRangeQuery</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=tsing.fun title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>zhanghb</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-04-02>2022-04-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1463 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#译文>译文：</a></li><li><a href=#原文>原文：</a><ul><li><a href=#rangequery-and-windowedrangequery>RangeQuery and WindowedRangeQuery</a></li><li><a href=#non-window-function-version>Non Window Function Version</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>近期在使用 SQLAlchemy 读取大批量数据的时候，遇到了一个问题，因为数据量过大而查询进程被 Kill 的问题，就想到了使用生成器或者单个请求拆分多次查询的方法。在 github 上找到了一篇 Wiki，照着 Wiki 中的方式，成功解决了 SQLAlchemy 查大数据失败的问题。</p><p>这篇 Wiki 文章比较短小，英文读起来也不吃力，但想着还是顺便练习一下翻译，水一篇博客好了。</p><h3 id=译文>译文：</h3><blockquote><p>Todo</p></blockquote><h3 id=原文>原文：</h3><blockquote><p>原文链接：<a href=https://github.com/sqlalchemy/sqlalchemy/wiki/RangeQuery-and-WindowedRangeQuery target=_blank rel="noopener noreffer">RangeQuery-and-WindowedRangeQuery</a>：</p></blockquote><h4 id=rangequery-and-windowedrangequery>RangeQuery and WindowedRangeQuery</h4><p>The goal is to select through a very large number of rows that&rsquo;s too large to fetch all at once. Many DBAPIs pre-buffer result sets fully, and otherwise it can be difficult to keep an active cursor when using an option like psycopg2&rsquo;s server side cursors. The usual alternative, i.e. to page through the results using LIMIT/OFFSET, has the downside that the OFFSET will scan through all the previous rows each time in order to get to the requested row. To overcome this, there are two approaches to page through results without using OFFSET.</p><p>The simplest is to order the results by a particular unique column (usually primary key), then fetch chunks using LIMIT only, adding a WHERE clause that will ensure we only fetch rows greater than the last one we fetched). This will work for basically any database backend and is illustrated below for MySQL. The potential downside is that the database needs to sort the full set of remaining rows for each chunk, which may inefficient, even though both recipes presented here assume the sort column is indexed. However, the approach is very simple and can likely work for most ordinary use cases for a primary key column on a database that does not support window functions.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def windowed_query(q, column, windowsize):
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;&#34;Break a Query into chunks on a given column.&#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    single_entity = q.is_single_entity
</span></span><span class=line><span class=cl>    q = q.add_column(column).order_by(column)
</span></span><span class=line><span class=cl>    last_id = None
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    while True:
</span></span><span class=line><span class=cl>        subq = q
</span></span><span class=line><span class=cl>        if last_id is not None:
</span></span><span class=line><span class=cl>            subq = subq.filter(column &gt; last_id)
</span></span><span class=line><span class=cl>        chunk = subq.limit(windowsize).all()
</span></span><span class=line><span class=cl>        if not chunk:
</span></span><span class=line><span class=cl>            break
</span></span><span class=line><span class=cl>        last_id = chunk[-1][-1]
</span></span><span class=line><span class=cl>        for row in chunk:
</span></span><span class=line><span class=cl>            if single_entity:
</span></span><span class=line><span class=cl>                yield row[0]
</span></span><span class=line><span class=cl>            else:
</span></span><span class=line><span class=cl>                yield row[0:-1]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if __name__ == &#34;__main__&#34;:
</span></span><span class=line><span class=cl>    from sqlalchemy import Column, Integer, create_engine
</span></span><span class=line><span class=cl>    from sqlalchemy.orm import Session
</span></span><span class=line><span class=cl>    from sqlalchemy.ext.declarative import declarative_base
</span></span><span class=line><span class=cl>    import random
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Base = declarative_base()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    class Widget(Base):
</span></span><span class=line><span class=cl>        __tablename__ = &#34;widget&#34;
</span></span><span class=line><span class=cl>        id = Column(Integer, primary_key=True)
</span></span><span class=line><span class=cl>        data = Column(Integer)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    e = create_engine(&#34;mysql://scott:tiger@localhost/test&#34;, echo=&#34;debug&#34;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Base.metadata.drop_all(e)
</span></span><span class=line><span class=cl>    Base.metadata.create_all(e)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # get some random list of unique values
</span></span><span class=line><span class=cl>    data = set([random.randint(1, 1000000) for i in range(10000)])
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    s = Session(e)
</span></span><span class=line><span class=cl>    s.add_all([Widget(id=i, data=j) for i, j in enumerate(data, 1)])
</span></span><span class=line><span class=cl>    s.commit()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q = s.query(Widget)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    for widget in windowed_query(q, Widget.data, 1000):
</span></span><span class=line><span class=cl>        print(&#34;data:&#34;, widget.data)
</span></span></code></pre></td></tr></table></div></div><p>A more elaborate way to do this, which allows that the table rows are fully sorted only once, is to use a window function in order to establish the exact range for each &ldquo;chunk&rdquo; ahead of time, and then to yield chunks as rows selected within that range. This works only on databases that support windows functions. This recipe has been on the SQLAlchemy Wiki for a long time but it&rsquo;s not clear how much advantage it has over the previous simpler approach; both approaches should be evaluated for efficiency for a given use case.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import sqlalchemy
</span></span><span class=line><span class=cl>from sqlalchemy import and_, func
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def column_windows(session, column, windowsize):
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;Return a series of WHERE clauses against 
</span></span><span class=line><span class=cl>    a given column that break it into windows.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Result is an iterable of tuples, consisting of
</span></span><span class=line><span class=cl>    ((start, end), whereclause), where (start, end) are the ids.
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Requires a database that supports window functions, 
</span></span><span class=line><span class=cl>    i.e. Postgresql, SQL Server, Oracle.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Enhance this yourself !  Add a &#34;where&#34; argument
</span></span><span class=line><span class=cl>    so that windows of just a subset of rows can
</span></span><span class=line><span class=cl>    be computed.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;
</span></span><span class=line><span class=cl>    def int_for_range(start_id, end_id):
</span></span><span class=line><span class=cl>        if end_id:
</span></span><span class=line><span class=cl>            return and_(
</span></span><span class=line><span class=cl>                column&gt;=start_id,
</span></span><span class=line><span class=cl>                column&lt;end_id
</span></span><span class=line><span class=cl>            )
</span></span><span class=line><span class=cl>        else:
</span></span><span class=line><span class=cl>            return column&gt;=start_id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q = session.query(
</span></span><span class=line><span class=cl>                column, 
</span></span><span class=line><span class=cl>                func.row_number().\
</span></span><span class=line><span class=cl>                        over(order_by=column).\
</span></span><span class=line><span class=cl>                        label(&#39;rownum&#39;)
</span></span><span class=line><span class=cl>                ).\
</span></span><span class=line><span class=cl>                from_self(column)
</span></span><span class=line><span class=cl>    if windowsize &gt; 1:
</span></span><span class=line><span class=cl>        q = q.filter(sqlalchemy.text(&#34;rownum %% %d=1&#34; % windowsize))
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    intervals = [id for id, in q]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    while intervals:
</span></span><span class=line><span class=cl>        start = intervals.pop(0)
</span></span><span class=line><span class=cl>        if intervals:
</span></span><span class=line><span class=cl>            end = intervals[0]
</span></span><span class=line><span class=cl>        else:
</span></span><span class=line><span class=cl>            end = None
</span></span><span class=line><span class=cl>        yield int_for_range(start, end)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def windowed_query(q, column, windowsize):
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;&#34;Break a Query into windows on a given column.&#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    for whereclause in column_windows(
</span></span><span class=line><span class=cl>                                        q.session, 
</span></span><span class=line><span class=cl>                                        column, windowsize):
</span></span><span class=line><span class=cl>        for row in q.filter(whereclause).order_by(column):
</span></span><span class=line><span class=cl>            yield row
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if __name__ == &#39;__main__&#39;:
</span></span><span class=line><span class=cl>    from sqlalchemy import Column, Integer, create_engine
</span></span><span class=line><span class=cl>    from sqlalchemy.orm import Session
</span></span><span class=line><span class=cl>    from sqlalchemy.ext.declarative import declarative_base
</span></span><span class=line><span class=cl>    import random
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Base = declarative_base()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    class Widget(Base):
</span></span><span class=line><span class=cl>        __tablename__ = &#39;widget&#39;
</span></span><span class=line><span class=cl>        id = Column(Integer, primary_key=True)
</span></span><span class=line><span class=cl>        data = Column(Integer)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    e = create_engine(&#39;postgresql://scott:tiger@localhost/test&#39;, echo=&#39;debug&#39;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Base.metadata.drop_all(e)
</span></span><span class=line><span class=cl>    Base.metadata.create_all(e)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    # get some random list of unique values
</span></span><span class=line><span class=cl>    data = set([random.randint(1, 1000000) for i in xrange(10000)])
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    s = Session(e)
</span></span><span class=line><span class=cl>    s.add_all([Widget(id=i, data=j) for i, j in enumerate(data)])
</span></span><span class=line><span class=cl>    s.commit()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q = s.query(Widget)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    for widget in windowed_query(q, Widget.data, 1000):
</span></span><span class=line><span class=cl>        print &#34;data:&#34;, widget.data
</span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s an example of the kind of SQL this emits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-- first, it gets a list of ranges, with 1000 values in each bucket
</span></span><span class=line><span class=cl>SELECT anon_1.widget_data AS anon_1_widget_data 
</span></span><span class=line><span class=cl>FROM (SELECT widget.data AS widget_data, row_number() OVER (ORDER BY widget.data) AS rownum 
</span></span><span class=line><span class=cl>FROM widget) AS anon_1 
</span></span><span class=line><span class=cl>WHERE rownum %% 1000=1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Col (&#39;anon_1_widget_data&#39;,)
</span></span><span class=line><span class=cl>Row (4,)
</span></span><span class=line><span class=cl>Row (100107,)
</span></span><span class=line><span class=cl>Row (200004,)
</span></span><span class=line><span class=cl>Row (299526,)
</span></span><span class=line><span class=cl>Row (397664,)
</span></span><span class=line><span class=cl>Row (502373,)
</span></span><span class=line><span class=cl>Row (597853,)
</span></span><span class=line><span class=cl>Row (695306,)
</span></span><span class=line><span class=cl>Row (798335,)
</span></span><span class=line><span class=cl>Row (899000,)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-- then, the original query is run for each window, adding in 
</span></span><span class=line><span class=cl>-- the extra range criterion
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SELECT widget.id AS widget_id, widget.data AS widget_data 
</span></span><span class=line><span class=cl>FROM widget 
</span></span><span class=line><span class=cl>WHERE widget.data &gt;= %(data_1)s AND widget.data &lt; %(data_2)s ORDER BY widget.data
</span></span><span class=line><span class=cl>-- values: {&#39;data_2&#39;: 100107, &#39;data_1&#39;: 4}
</span></span><span class=line><span class=cl>Col (&#39;widget_id&#39;, &#39;widget_data&#39;)
</span></span><span class=line><span class=cl>Row (1, 4)
</span></span><span class=line><span class=cl>Row (64, 211)
</span></span><span class=line><span class=cl>Row (5415, 554)
</span></span><span class=line><span class=cl>Row (168, 568)
</span></span><span class=line><span class=cl>Row (203, 672)
</span></span><span class=line><span class=cl>Row (275, 914)
</span></span><span class=line><span class=cl>Row (343, 1124)
</span></span><span class=line><span class=cl>Row (344, 1132)
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SELECT widget.id AS widget_id, widget.data AS widget_data 
</span></span><span class=line><span class=cl>FROM widget 
</span></span><span class=line><span class=cl>WHERE widget.data &gt;= %(data_1)s AND widget.data &lt; %(data_2)s ORDER BY widget.data
</span></span><span class=line><span class=cl>-- values: {&#39;data_2&#39;: 200004, &#39;data_1&#39;: 100107}
</span></span><span class=line><span class=cl>Col (&#39;widget_id&#39;, &#39;widget_data&#39;)
</span></span><span class=line><span class=cl>Row (544, 100107)
</span></span><span class=line><span class=cl>Row (549, 100120)
</span></span><span class=line><span class=cl>Row (583, 100225)
</span></span><span class=line><span class=cl>Row (3564, 100235)
</span></span><span class=line><span class=cl>Row (588, 100241)
</span></span><span class=line><span class=cl>Row (594, 100258)
</span></span><span class=line><span class=cl>Row (599, 100274)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><h4 id=non-window-function-version>Non Window Function Version</h4><p>Don&rsquo;t have window functions on the target database? Here&rsquo;s an approach that uses LIMIT in conjunction with tracking the last fetched primary key:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def _yield_limit(qry, pk_attr, maxrq=100):
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;specialized windowed query generator (using LIMIT/OFFSET)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    This recipe is to select through a large number of rows thats too
</span></span><span class=line><span class=cl>    large to fetch at once. The technique depends on the primary key
</span></span><span class=line><span class=cl>    of the FROM clause being an integer value, and selects items
</span></span><span class=line><span class=cl>    using LIMIT.&#34;&#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    firstid = None
</span></span><span class=line><span class=cl>    while True:
</span></span><span class=line><span class=cl>        q = qry
</span></span><span class=line><span class=cl>        if firstid is not None:
</span></span><span class=line><span class=cl>            q = qry.filter(pk_attr &gt; firstid)
</span></span><span class=line><span class=cl>        rec = None
</span></span><span class=line><span class=cl>        for rec in q.order_by(pk_attr).limit(maxrq):
</span></span><span class=line><span class=cl>            yield rec
</span></span><span class=line><span class=cl>        if rec is None:
</span></span><span class=line><span class=cl>            break
</span></span><span class=line><span class=cl>        firstid = pk_attr.__get__(rec, pk_attr) if rec else None
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if __name__ == &#39;__main__&#39;:
</span></span><span class=line><span class=cl>    from sqlalchemy import create_engine, Column, Integer
</span></span><span class=line><span class=cl>    from sqlalchemy.orm import Session
</span></span><span class=line><span class=cl>    from sqlalchemy.ext.declarative import declarative_base
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Base = declarative_base()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    class A(Base):
</span></span><span class=line><span class=cl>        __tablename__ = &#39;a&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        id = Column(Integer, primary_key=True)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    e = create_engine(&#34;sqlite://&#34;, echo=True)
</span></span><span class=line><span class=cl>    Base.metadata.create_all(e)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sess = Session(e)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sess.add_all([A() for i in range(2000)])
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    for rec in _yield_limit(sess.query(A), A.id):
</span></span><span class=line><span class=cl>        print(rec.id, rec)
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-04-02</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/sqlalchemy-rangequery/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery" data-via=binbinah><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://tsing.fun/sqlalchemy-rangequery/><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery"><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=http://tsing.fun/sqlalchemy-rangequery/ data-title="[译文] RangeQuery and WindowedRangeQuery"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/first_post/ class=prev rel=prev title=01.博客开篇><i class="fas fa-angle-left fa-fw"></i>01.博客开篇</a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.96.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=tsing.fun target=_blank>zhanghb</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>